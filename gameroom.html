<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Casino â€“ Game Room</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <header class="topbar">
    <div>ğŸ° Game Room</div>
    <div id="userinfo"></div>
    <button id="logout">Logout</button>
  </header>

  <main class="room">
    <section class="slot">
      <h2>Classic 3Ã—3 Slot</h2>

      <div class="reels" id="reels">
        <div class="reel" id="r1">ğŸ‹</div>
        <div class="reel" id="r2">ğŸ’</div>
        <div class="reel" id="r3">ğŸ””</div>
      </div>

      <div class="controls">
        <label>Bet $
          <input type="number" id="bet" min="1" step="1" value="10">
        </label>
        <button id="spin">Spin</button>
      </div>
      <div id="result" class="result"></div>

      <details>
        <summary>Payout table</summary>
        <ul>
          <li>3Ã— ğŸ’ = 50Ã— bet</li>
          <li>3Ã— ğŸ”” = 20Ã— bet</li>
          <li>3Ã— ğŸ’ = 10Ã— bet</li>
          <li>3Ã— ğŸ‹ = 5Ã— bet</li>
          <li>Any 2 of a kind = 2Ã— bet</li>
          <li>No match = 0</li>
        </ul>
      </details>
    </section>
  </main>

  <script type="module">
    import { auth } from './assets/js/auth.js';
    import { Storage } from './assets/js/storage.js';
    import { Slots } from './assets/js/slots.js';
    import { $ } from './assets/js/ui.js';

    const me = auth.requirePlayer(); // redirects if not logged in
    const balanceEl = document.createElement('span');

    function renderUserInfo() {
      const fresh = Storage.getUser(me.username); // re-read, balance may have changed
      balanceEl.textContent = `Balance: $${fresh.balance}`;
      $('#userinfo').innerHTML = `Player: <strong>${fresh.username}</strong> â€¢ `;
      $('#userinfo').appendChild(balanceEl);
    }

    renderUserInfo();

    $('#logout').onclick = () => { auth.logout(); location.href = 'index.html'; };

    $('#spin').onclick = () => {
      const bet = Math.max(1, Math.floor(Number($('#bet').value || 1)));
      const user = Storage.getUser(me.username);
      if (bet > user.balance) return alert('Insufficient balance.');
      const outcome = Slots.spin(bet); // {symbols:[...], delta, payout, msg}

      // Apply game outcome to the player's account
      const newBal = user.balance + outcome.delta;
      Storage.updateUser(user.username, { balance: newBal });

      // Animate reels + show result
      const [a,b,c] = outcome.symbols;
      $('#r1').textContent = a; $('#r2').textContent = b; $('#r3').textContent = c;
      $('#result').textContent = `${outcome.msg} (Î” ${outcome.delta >= 0 ? '+' : ''}${outcome.delta}) â€” New balance: $${newBal}`;

      renderUserInfo();
    };
  </script>
</body>
</html>
